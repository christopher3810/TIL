***

## 서브쿼리 위치에 따른 SQL 용어

---

-   서브쿼리란? : 쿼리 안의 보조쿼리를 가르키는 용어
    
    -   작성 위치는 크게 보통 SELECT , FROM , WHERE 절로 나뉩니다
    
    ```sql
    SELECT //메인쿼리 (SELECT  .... FROM ...) //SELECT절 안에 SELECT절 스칼라 서브쿼리
    FROM //메인쿼리 (SELECT ... FROM ...) // FROM절 인라인 뷰
    WHERE 컬럼명 IN //메인쿼리 (SELECT ... FROM ...) //WHERE절 중첩 서브쿼리
    ```
    

<br>

### 스칼라 서브쿼리

---

-   scalar - 하나의 숫자로만 표시되는양 || 단순히 하나의 숫자를 의미
    
    -   스칼라 서브쿼리 : SELECT 절 내부에 하나의 숫자. 문자, 기호 등을 출력하는 SELECT 문
-   FROM절이나 WHERE절에도 스칼라 서브쿼리를 사용할 수 있으나 대부분 SQL문에서 SELECT 절에 사용하므로 SELECT절 기준으로 설명 합니다
    
-   메인쿼리 SELECT절에는 최종 출력하려는 열들이 나열되므로 만약 출력데이터가 1건이면 스칼라 서브쿼리의 결과 건수도 1개가 나와야 합니다. 즉 1행 1열 구조로 출력해야 합니다.
    
    ```sql
    SELECT 이름,
    				(SELECT COUNT(*)
    				 FROM 학생 AS 학생2
    				 WHERE 학생2.이름 = 학생1.이름) 카운트
    	FROM 학생 AS 학생1;
    ```
    
    -   보통 스칼라 서브쿼리는 출력되는 데이터 건수가 1건이어야 하므로 집계함수(max, min, avg, sum, count) 가 자주 쓰입니다

<br>

### 인라인 뷰

---

-   FROM 절에서 임시적으로 뷰를 생성하는 방식이므로 인라인 뷰라고 불립니다.
    
    -   인라인 뷰의 결과는 내부적으로 메모리 또는 디스크에 임시 테이블을 생성하여 활용합니다
    
    ```sql
    SELECT 학생2.학번, 학생2.이름
    	FROM (SELECT *
    					FROM 학생
    					WHERE 성별 = '남') 학생2;
    ```
    

<br>

### 중첩 서브 쿼리

---

-   WHERE 절에서 단순한 값을 비교 연산하는 대신, 서브쿼리를 추가하여 비교 연산하기 위해 중첩 서브쿼리를 사용합니다.
    
    -   이처럼 WHERE절에서 중첩 서브쿼리와 비교시 보통 비교연산자( > , < , ≥ , ≤ ....)를 비롯해 IN , EXISTS , NOT , NOT EXISTS 문을 자주 사용합니다.
    
    ```sql
    SELECT *
    	FROM 학생
    	WHERE 학번 = (SELECT MAX(학번) FROM 학생)
    ```
    

<br>

## 메인쿼리와의 관계성에 따른 SQL 용어

---

<br>

### 비상관 서브쿼리

---

-   메인쿼리와 서브쿼리 간에 관계성이 없음을 의미합니다.
    
    -   서브쿼리가 독자적으로 실행된 뒤 메인쿼리에게 그 결과를 던져주는 형태.
    
    ```sql
    SELECT *
    	FROM 학생
    	WHERE 학번 IN (SELECT 학번
    							FROM 학생			
    							WHERE 성별 = '남')
    //성별 남 조건으로 학생 테이블에서 가져온뒤 
    //그 결과를 메인쿼리의 학생 테이블로 전달하여 최종데이터 출력
    ```
    
    -   서브 쿼리가 먼저 실행된 뒤에 그 결과를 메인쿼리가 활용합니다.
        
        -   **서브쿼리 실행 → 메인쿼리 실행 순서로 실행됩니다.**
        
        <aside> 🔥 DB 버전 및 옵티마이저에 따라 서브쿼리가 제거되고 하나의 메인쿼리로 통합되는 뷰 병합 즉 SQL 재작성이 작동할수도 있습니다.
        
        </aside>
        

<br>

### 상관 서브쿼리

---

-   메인 쿼리와 서브쿼리 간에 관계성이 있음을 의미합니다.
    -   서브쿼리가 수행되려면 메인쿼리의 값을 받아야 하므로 끈끈한 관계를 유지합니다.
        
        -   SELECT 절에 작성하는 스칼라 서브쿼리와 WHERE절에 작성하는 중첩 서브쿼리일때 발생.
        
        ```sql
        SELECT *
        	FROM 학생
        WHERE ... IN (SELECT ...
        							FROM 지도교수
        							WHERE 학생.학번 = 지도교수.학번)
        ```
        
        -   서브쿼리에 where 절에 메인쿼리의 학생.학번을 명시하므로써 관계성을 뚜렷히 보여줍니다.
            
            -   수행순서 **메인쿼리 실행(학생.학번 데이터 가져오기) → 서브쿼리 실행(지도교수.학번 = 학생.학번) → 다시 메인쿼리 실행한 뒤 결과 출력(SELECT * FROM 학생~)과 같습니다.**
            
            <aside> 🔥 이때도 DB 버전 및 옵티마이저에 따라 서브쿼리가 제거되고 하나의 메인쿼리로 통합되는 뷰 병합 즉 SQL 재작성이 작동할수도 있습니다.
            
            </aside>
            

<br>

## 반환 결과에 따른 SQL 용어

---

🗂️ 서브쿼리의 결과 유형은 수치적 기준으로 구분할 수 있습니다

-   1건의 행 데이터만 반환하는 경우
-   2개 이상의 행 데이터를 반환하는 경우
-   2개 이상의 행과 열 데이터를 반환하는 경우

<br>

### 단일행 서브쿼리

---

-   서브쿼리 결과가 1건의 행으로 반환되는 쿼리입니다 (보통 =, < , > 의 연산자를 사용합니다.)

```sql
SELECT ...
FROM ...
WHERE 학번 = // 서브쿼리 SELECT MAX(학번) FROM 학생.... (출력값이 1개인 서브쿼리)
```

<br>

### 다중행 서브쿼리

---

-   서브쿼리 결과가 여러 건의 행으로 반환되는 쿼리 입니다.
-   메인쿼리의 조건절에서는 IN 구문으로 서브쿼리에서 반환되는 값들을 받습니다.

```sql
SELECT...
FROM...
WHERE 학번 IN // 서브쿼리 SELECT MAX(학번) FROM 학생 GROUP BY 전공코드 (출력값 2개이상)
```

<br>

### 다중열 서브쿼리

---

-   서브쿼리 결과가 여러 개의 열과 행으로 반환됩니다.
-   메인쿼리의 조건절에서는 IN 구문과 함께 서브쿼리에서 반환될 열들을 동일하게 나열해 서브쿼리 결과를 받습니다.

```sql
SELECT ...
FROM ...
WHERE (이름, 전공코드) IN // 서브쿼리 SELECT 이름, 전공코드 FROM 학생, WHERE 이름 LIKE '김%'
```

<br>

### 참조
***
[aws-redshift](https://docs.aws.amazon.com/redshift/latest/dg/r_scalar_subqueries.html)\
[oracle](https://docs.oracle.com/cd/E28280_01/bi.1111/e10544/appsql.htm#BIEUG14135)\
[업무에 바로 쓰는 SQL 튜닝](http://www.yes24.com/Product/Goods/102382080)
