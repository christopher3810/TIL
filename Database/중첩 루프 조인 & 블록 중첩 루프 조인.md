***

### 중첩 루프 조인

  

---

- 중첩 루프 조인(nested loop join (NL조인))은 드라이빙 테이블의 데이터 1건당 드리븐 테이블을 반복해 검색하여 최종적으로는 양쪽 테이블에 공통된 데이터를 출력합니다.


- 예시

```sql

SELECT 학생.학번, 학생.이름,

비상연락망.관계, 비상연락망.연락처

FROM 학생

JOIN 비상연락망

ON 학생.학번 = 비상연락망.학번

WHERE 학생.학번 IN (1, 100)

```

1. 학번 1을 학생테이블에서 검색하려고 학생 테이블 데이터 100건에 모두 접근합니다.

2. 학생 1과 동일한 데이터를 가졌는지 비교해보려고 비상연락망 테이블의 데이터 1000건에 모두 접근합니다.

3. 다음으로 학생 100의 정보를 찾고자 학생 테이블 데이터 100건에 모두 접근합니다

4. 마찬가지로 학생 100의 정보와 동일한 데이터를 가졌는지 비교해보려고 비상연락망 테이블에서 학번 100을 찾는 작업을 합니다.

- 학번 1 데이터 (100 + 1000) , 학번 100 데이터 (100 + 1000) = 2200 건의 데이터에 접근

- 해당 예제가 학생 테이블에 학번 열로 인덱스가 생성되어 있고, 비상연락망 테이블에도 학번열로 인덱스가 생성되어 있는 환경이라면 각 테이블에 생성된 인덱스로 데이터에 접근합니다.

![중첩루프조인_ex1](https://user-images.githubusercontent.com/61622657/226082225-36492e26-ee91-4336-bcfa-0dfa7ba15a47.png)


- 학생 1번 데이터 (1 + 2), 학생 100번 데이터 (1+1) = 총 6건의 데이터에 접근하게 됩니다.

- 사실 인덱스는 인덱스로 정의된 열 기준으로 순차 정렬 되지만, 인덱스를 이용해 테이블의 데이터를 찾아가는 과정에서 임의 접근 방식인 랜덤 액세스가 발생합니다.

- 랜덤 엑세스 범위를 좁히는 방향으로 인덱스를 설계하고 조건절을 작성해야 합니다.

- **단 랜덤 엑세스를 유발하는 인덱스는 기본키가 아닌 비고유 인덱스일 경우에 해당합니다.**

- 기본키는 클러스터형 인덱스이므로 키의 순서대로 테이블의 데이터가 적재되어 있어 조회 효율이 매우 높습니다.

  

### 블록 중첩 루프 조인

---

  

- 블록 중첩 루프 조인(Block nested loop join)(BNL 조인)

- 만약 학생테이블이 드라이빙 테이블이고 드리븐 테이블인 비상연락망 테이블이 인덱스가 없다고 가정 한다면 인덱스가 없는 드리븐 테이블에 대해 매번 전체 데이터를 비효율적으로 검색해야 할것 입니다.

- 이때 중첩 루프 조인의 효율성을 높이고자 탄생한 것이 바로 블록 중첩 루프 조인입니다.

- 드라이빙 테이블에 대해 조인 버퍼 라는 개념을 도입하여 조인 성능의 향상을 꾀할 수 있습니다.

- BNL 조인 수행 절차

![BNL조인](https://user-images.githubusercontent.com/61622657/226082270-b936d19f-bdcc-45c7-ae1f-63b7765a68f8.png)


1. 드라이빙 테이블인 학생 테이블에서 학번 1과 100에 해당하는 데이터를 검색 합니다.

2. 검색된 데이터를 0 조인 버퍼에 가득 채워질 때까지 적재합니다.

3. 0 조인버퍼와 비상연락망 테이블의 데이터를 비교합니다. - 0조인 버퍼와 2 데이터를 조인, 다시 0 조인버퍼와 3데이터를 조인 하는 식으로 반복하며 모두 접근합니다.

4. 이처럼 조인 버퍼의 데이터들과 비상연락망 테이블의 한 번의 데이터 풀 스캔으로 원하는 데이터를 모두 찾을 수 있습니다.(매번 풀스캔이아닌 한번의 풀스캔으로 확인)

- 비상연락망 테이블의 테이블 풀 스캔을 줄이는 게 목적으로 성능 저하를 개선하는 조인 알고리즘 방식입니다.

- 블록 해시 조인 이라는 방식도 있지만 블록 중첩 루프 조인 방식과 매우 유사(조인 버퍼에 쌓인 데이터에 대해 해시값을 적용하고 그 값을 기준으로 비상연락망 테이블과 조인을 수행)


### 참조
***
[업무에 바로 쓰는 SQL 튜닝](http://www.yes24.com/Product/Goods/102382080)
