

## 1. MVCC의 핵심 개념

MVCC는 여러 트랜잭션을 동시에 처리하면서도 데이터 일관성을 유지하는 방법을 제공하는 동시성 제어 메커니즘. 

MVCC의 핵심은 `각 트랜잭션이 데이터에 대한 고유한 스냅샷을 가지고 작업을 수행한다` 임.

## 2. MVCC의 동작 원리

PostgreSQL에서 트랜잭션이 데이터를 수정할 때, 이 데이터의 새로운 버전이 생성됨. 

이전 버전은 여전히 보존되며, 이를 통해 다른 트랜잭션이 해당 변경 사항을 '보지' 못한 상태에서 독립적인 작업을 수행할 수 있음.

즉, 모든 트랜잭션은 각자 고유한 데이터 뷰를 가지게 됨.

이 과정은 읽기와 쓰기 간의 락 경쟁을 크게 줄이며, 데이터 일관성을 높이는 데 중요한 역할을 함.

### 3. 트랜잭션 ID와 시스템 칼럼



PostgreSQL에서는 트랜잭션이 시작될 때마다 각 트랜잭션에 `고유한 Transaction ID`를 부여함. 

이 Transaction ID는 `트랜잭션의 수명 동안 유지`되며, 트랜잭션이 수행하는 모든 연산에 대해 추적 가능하게 함.


![postgres_mvcc](https://github.com/christopher3810/TIL/assets/61622657/fbe68260-c4aa-444d-b575-0c61e5b40491)
출처 : https://github.com/christopher3810/TIL/assets/61622657/fbe68260-c4aa-444d-b575-0c61e5b40491

이렇게 생성된 Transaction ID는 튜플(레코드)의 시스템 칼럼인 `xmin`과 `xmax`에 사용됨.

<h5>xmin</h5>

`xmin`은 튜플을 생성하거나 갱신하는 트랜잭션의 ID를 저장함. 

즉, 튜플이 생성되거나 갱신된 시점의 Transaction ID를 가리킴.

<h5>xmax</h5>

반면에 `xmax`는 튜플을 삭제하거나 갱신하는 트랜잭션의 ID를 저장함.

이 경우, 튜플이 삭제되거나 갱신되는 시점의 Transaction ID를 가리킴. 

<h5>갱신</h5>

갱신의 경우, 갱신되기 이전 튜플의 `xmax`와 갱신된 신규 튜플의 `xmin`에는 해당 시점의 Transaction ID가 할당되고, 갱신된 신규 튜플의 `xmax`에는 NULL이 할당.


### 3.1 트랜잭션 ID와 스냅샷

트랜잭션에서 SELECT 쿼리를 실행할 때, PostgreSQL은 해당 시점의 `스냅샷`을 생성.

이 `스냅샷`은 데이터베이스의 특정 시점의 상태를 나타내며, 트랜잭션이 실행되는 동안 일관성 있는 뷰를 제공.

`스냅샷`은 해당 시점에서 실행 중인 모든 트랜잭션의 ID 목록을 포함.

즉, `스냅샷`은 트랜잭션 ID를 기반으로 해당 트랜잭션이 `보아야 할 데이터`를 결정합니다.

트랜잭션이 특정 튜플에 접근하려고 할 때, PostgreSQL은 `xmin`과 `xmax`의 값을 확인하여 트랜잭션의 스냅샷과 비교.

이를 통해 트랜잭션에게 보여줄 적절한 튜플 버전을 결정.

### 3.2 MVCC와 로우 수준 잠금

MVCC는 PostgreSQL에서 로우 수준 잠금과 함께 동작하여 동시성을 향상 시킴. 

로우 수준 잠금은 특정 튜플에 대한 동시 업데이트를 방지하고, MVCC는 동시 읽기를 가능하게 함. 

이 두 가지 기능의 조화로 인해 PostgreSQL은 고성능의 동시성 제어를 구현.

### 3.3 VACUUM과 튜플 버전 관리

PostgreSQL에서는 오래된 튜플 버전을 정리하는 VACUUM 프로세스를 제공.

이는 데이터베이스의 공간을 효율적으로 활용하며, 더 이상 사용되지 않는 오래된 튜플 버전을 제거함으로써 성능을 향상시킴.

이 VACUUM 프로세스는 설정에 따라 자동으로 실행되거나 수동으로 실행할 수 있음.

이는 PostgreSQL의 MVCC 구현이 데이터베이스의 성능과 공간 효율성을 유지하는 데 중요한 역할을 하는 것을 보여줌.

## 4. MVCC의 장점과 단점

MVCC는 동시에 많은 트랜잭션을 처리하면서도 데이터 일관성을 유지하게 해주는 강력한 메커니즘이지만, 이러한 방식은 공간 복잡성을 증가시키며 'vacuuming'이라는 가비지 컬렉션 과정을 필요로 합니다.

더 이상 필요하지 않은 오래된 행 버전을 정리하고, 사용 가능한 공간으로 재활용하는 이 과정은 CPU와 I/O 리소스를 소모하며, 빈번한 데이터 변경이 있는 경우 이 overhead가 상당할 수 있습니다.

하지만 이러한 복잡성에도 불구하고, MVCC는 PostgreSQL의 핵심 기능 중 하나로, 대용량 데이터를 효과적으로 처리하는 데 필수적인 기능입니다.

위에서 설명한 MVCC의 원리를 통해, 우리는 PostgreSQL의 강력한 동시성 제어 기능을 이해하고 활용할 수 있습니다. 이렇게 복잡한 내부 구조가 사용자에게는 단순하고 효과적인 동시성 제어로 제공되는 것이 바로 PostgreSQL의 뛰어난 설계 능력이라고 할 수 있습니다.